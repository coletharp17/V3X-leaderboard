<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chivalry 2 Leaderboard — Final (with diagnostics)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#0b1020; --card:#121a33cc; --card-border:#2a355f; --text:#e7ecff; --muted:#9aa6d1;
    --accent:#5b8cff; --accent2:#9c7bff; --accent3:#2ee7c9; --glow: 0 10px 30px rgba(91,140,255,0.30);
    --ok:#2ee7c9; --warn:#ffd166; --err:#ff6b6b;
  }
  body{margin:0; padding:2rem 1.2rem 4rem; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
       background: radial-gradient(1200px 800px at 10% -10%, rgba(91,140,255,0.15), transparent 60%),
                   radial-gradient(900px 700px at 110% 10%, rgba(156,123,255,0.12), transparent 60%),
                   radial-gradient(1000px 900px at 50% 120%, rgba(46,231,201,0.10), transparent 60%),
                   var(--bg); color:var(--text)}
  header{max-width:1200px; margin:0 auto 1rem auto; display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;}
  h1{font-weight:800; letter-spacing:0.4px; margin:0}
  .sub{color:var(--muted)}
  .status{max-width:1200px; margin:0 auto 1rem auto; border:1px solid var(--card-border); background:#0d1430; border-radius:12px; padding:.7rem .9rem; font-size:.92rem;}
  .status .ok{color:var(--ok)} .status .warn{color:var(--warn)} .status .err{color:var(--err)}
  .grid{max-width:1200px; margin:0 auto; display:grid; gap:1rem; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr));}
  .card{position:relative; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)), var(--card); border:1px solid var(--card-border);
        border-radius:16px; padding:1rem 1rem 1.1rem; box-shadow: var(--glow);}
  .rank{position:absolute; top:.8rem; right:.9rem; font-weight:800; color:#bdc9ff33; font-size:2.2rem; line-height:1;}
  .name{font-weight:800; font-size:1.15rem; letter-spacing:0.2px;}
  .score{font-weight:800; font-size:2.0rem; margin-top:.25rem; background:linear-gradient(135deg, var(--accent), var(--accent3)); -webkit-background-clip:text; background-clip:text; color:transparent;}
  .pill{background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); padding:.2rem .5rem; border-radius:999px; color:#9aa6d1; font-size:.82rem; display:inline-block; margin-right:.4rem; margin-top:.4rem}
  .tooltip{position:absolute; inset:auto auto 12px 12px; background:#0d1430; border:1px solid #2a355f; border-radius:14px; padding:.8rem .9rem; font-size:.9rem; line-height:1.35; box-shadow:0 12px 40px rgba(0,0,0,0.4); display:none; z-index:5; min-width: 260px;}
  .card:hover .tooltip{display:block}
  .tooltip .row{display:flex; justify-content:space-between; gap:1rem} .tooltip .row + .row{margin-top:.25rem}
</style>
</head>
<body>
  <header>
    <div>
      <h1>Chivalry 2 Leaderboard</h1>
      <div class="sub">Loads <code>results.csv</code> (+ optional <code>players.csv</code>) from this folder. This build shows detailed status/errors.</div>
    </div>
    <a class="sub" href="#" id="reload">↻ hard reload</a>
  </header>

  <div class="status" id="status">Booting…</div>
  <section class="grid" id="grid"></section>

<script>
function esc(s){return String(s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));}
function setStatus(msg, cls){ const el=document.getElementById('status'); el.className='status'; if(cls) el.classList.add(cls); el.innerHTML = msg; }
document.getElementById('reload').addEventListener('click', e=>{ e.preventDefault(); location.reload(true); });

async function fetchText(url){
  const u = new URL(url, location.href);
  // cache-bust every fetch
  u.searchParams.set('v', Date.now());
  const res = await fetch(u.toString(), {cache:'no-store'});
  if(!res.ok) throw new Error(url + ' HTTP ' + res.status);
  return await res.text();
}

async function loadCSV(url, requiredHeaders=null){
  try{
    const text = await fetchText(url);
    const parsed = Papa.parse(text.trim(), {header:true, dynamicTyping:true, skipEmptyLines:true});
    const headers = (parsed.meta && parsed.meta.fields) ? parsed.meta.fields : [];
    console.log('Loaded', url, 'headers:', headers, 'rows:', parsed.data.length);

    if(requiredHeaders){
      const missing = requiredHeaders.filter(h => !headers.includes(h));
      if(missing.length){
        setStatus(`Loaded <code>${esc(url)}</code> but missing header(s): <strong class="err">${esc(missing.join(', '))}</strong>. Found headers: <code>${esc(headers.join(', '))}</code>.`, 'err');
        return null;
      }
    }
    if(!parsed.data.length){
      setStatus(`Loaded <code>${esc(url)}</code> but it contains <span class="warn">0 rows</span>. Is the file empty?`, 'warn');
      return null;
    }
    return parsed.data;
  }catch(e){
    setStatus(`Failed to load <code>${esc(url)}</code>: <span class="err">${esc(e.message)}</span>. Ensure it is in the SAME folder as this HTML.`, 'err');
    console.error(e);
    return null;
  }
}

function num(v){ const x = Number(v); return Number.isFinite(x) ? x : 0; }

function render(rows, players){
  const grid = document.getElementById('grid');
  grid.innerHTML='';
  rows.sort((a,b)=> num(b.score) - num(a.score));
  const idx = Object.create(null);
  (players||[]).forEach(p => { idx[String(p.player_name||'').toLowerCase()] = p; });

  rows.forEach((r, i) => {
    const raw = idx[String(r.player_name||'').toLowerCase()] || {};
    const wr = (num(raw.Wins)+num(raw.Losses))>0 ? (num(raw.Wins)/(num(raw.Wins)+num(raw.Losses))) : NaN;
    const card = document.createElement('article');
    card.className='card';
    card.innerHTML = `
      <div class="rank">#${i+1}</div>
      <div class="name" title="${esc(r.player_name)}">${esc(r.player_name)}</div>
      <div class="score">${num(r.score).toFixed(2)}</div>
      <div>
        <span class="pill">KD ${num(r.raw_kd).toFixed(2)}</span>
        <span class="pill">WR ${num(r.wr_unit).toFixed(2)}</span>
        <span class="pill">EXP ${num(r.exp_unit).toFixed(2)}</span>
        <span class="pill">VERS ${num(r.vers_unit).toFixed(2)}</span>
      </div>
      <div class="tooltip">
        <div class="row"><span>Kills</span><strong>${esc(raw.K ?? '—')}</strong></div>
        <div class="row"><span>Deaths</span><strong>${esc(raw.D ?? '—')}</strong></div>
        <div class="row"><span>Wins</span><strong>${esc(raw.Wins ?? '—')}</strong></div>
        <div class="row"><span>Losses</span><strong>${esc(raw.Losses ?? '—')}</strong></div>
        <div class="row"><span>Win rate</span><strong>${isFinite(wr)? (wr*100).toFixed(1)+'%':'—'}</strong></div>
        <div class="row"><span>Hours</span><strong>${esc(raw.hours ?? '—')}</strong></div>
        <div class="row"><span>Weapons ≥1000</span><strong>${esc(raw.weapons_ge_1000 ?? '—')}</strong></div>
        <div class="row"><span>Revives</span><strong>${esc(raw.revives ?? '—')}</strong></div>
        <div class="row"><span>Items built</span><strong>${esc(raw.items ?? '—')}</strong></div>
      </div>
    `;
    grid.appendChild(card);
  });
  setStatus(`Loaded <strong class="ok">${rows.length}</strong> players from <code>results.csv</code> ✓`, '');
}

(async function init(){
  const results = await loadCSV('results.csv', ['player_name','raw_kd','kd_unit','wr_unit','exp_unit','vers_unit','rev_unit','build_unit','score']);
  if(!results) return;
  const players = await loadCSV('players.csv'); // optional
  render(results, players);
})();
</script>
</body>
</html>
